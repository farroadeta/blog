{{ define "main" }}
    <section class="hero hitokoto-section">
        <div class="hero-container">
            <div class="hero-image">
                <img src="{{ "images/banner.jpg" | relURL }}" alt="Banner">
            </div>
            <div class="hitokoto-content">
                <p class="hitokoto-text" id="hitokoto">正在加载一言...</p>
                <p class="hitokoto-from" id="hitokoto-from"></p>
            </div>
        </div>
    </section>
    <script>
        // 获取一言
        fetch('https://v1.hitokoto.cn')
            .then(response => response.json())
            .then(data => {
                document.getElementById('hitokoto').textContent = data.hitokoto;
                document.getElementById('hitokoto-from').textContent = '—' + (data.from_who || '佚名') + '《' + data.from + '》—';
            })
            .catch(error => {
                document.getElementById('hitokoto').textContent = '生活不止眼前的苟且，还有诗和远方。';
                document.getElementById('hitokoto-from').textContent = '—高晓松—';
            });
    </script>
    <section class="post-list">
        <div class="post-list-container">
            <h2 class="post-list-title">最近</h2>
            <div class="icity-card-list">
                {{ range first 10 (where (where .Site.RegularPages "Type" "ne" "character") "Layout" "ne" "search").ByDate.Reverse }}
                {{ $images := slice }}
                {{ with .Params.cover }}
                    {{ $images = $images | append . }}
                {{ end }}
                {{ $content := .Content }}
                {{ $imgMatches := findRE "<img[^>]+src=\"([^\"]+)\"" $content 3 }}
                {{ range $imgMatches }}
                    {{ $src := replaceRE ".*src=\"([^\"]+)\".*" "$1" . }}
                    {{ if not (in $images $src) }}
                        {{ $images = $images | append $src }}
                    {{ end }}
                {{ end }}
                {{ $imageCount := len $images }}
                {{ $author := .Params.author | default "七哇夸" }}
                {{ $avatar := printf "images/author/%s.png" $author }}
                {{ $authorKey := "qiwa" }}
                {{ if eq $author "商人" }}{{ $authorKey = "shangren" }}
                {{ else if eq $author "地理学家" }}{{ $authorKey = "dilixuejia" }}
                {{ else if eq $author "小王子" }}{{ $authorKey = "xiaowangzi" }}
                {{ else if eq $author "狐狸" }}{{ $authorKey = "huli" }}
                {{ else if eq $author "玫瑰" }}{{ $authorKey = "meigui" }}
                {{ else if eq $author "蛇" }}{{ $authorKey = "she" }}
                {{ else if eq $author "酒鬼" }}{{ $authorKey = "jiugui" }}
                {{ end }}
                {{ $signature := index $.Site.Params.authorSignatures $authorKey | default $.Site.Params.authorSignatures.qiwa }}
                <article class="icity-card" data-images="{{ $images | jsonify }}" data-url="{{ .RelPermalink }}">
                    <div class="icity-card-header">
                        <a href="{{ "/character/" | relURL }}{{ $author | urlize }}" class="icity-card-avatar-link" title="查看{{ $author }}的详情">
                            <div class="icity-card-avatar">
                                <img src="{{ $avatar | relURL }}" alt="{{ $author }}的头像">
                            </div>
                        </a>
                        <div class="icity-card-user">
                            <a href="{{ "/character/" | relURL }}{{ $author | urlize }}" class="icity-card-username-link">
                                <span class="icity-card-username">{{ $author }}</span>
                            </a>
                            <span class="icity-card-signature">{{ $signature }}</span>
                        </div>
                    </div>
                    <div class="icity-card-body">
                        {{ if and .Title (ne .Title "no") }}
                        <h3 class="icity-card-title">
                            <a href="{{ .RelPermalink }}">{{ .Title }}</a>
                        </h3>
                        {{ end }}
                        <p class="icity-card-content">{{ .Plain | truncate 200 }}</p>
                        {{ if gt $imageCount 0 }}
                        <div class="icity-card-images" data-count="{{ $imageCount }}">
                            {{ range first 3 $images }}
                            <div class="icity-image-item">
                                <img src="{{ . }}" alt="图片" loading="lazy">
                            </div>
                            {{ end }}
                        </div>
                        {{ end }}
                    </div>
                    <div class="icity-card-footer">
                        <span class="icity-card-date">{{ .Date.Format "2006年01月02日" }}</span>
                        <span class="icity-card-path">
                            {{ with .File }}
                                {{ $path := replace .Dir "\\" "/" }}
                                {{ $path = replace $path "posts/" "" }}
                                {{ $path = trim $path "/" }}
                                {{ if $path }}
                                    {{ replace $path "/" "/" }}
                                {{ end }}
                            {{ end }}
                        </span>
                    </div>
                </article>
                {{ end }}
            </div>
        </div>
    </section>
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            const cards = document.querySelectorAll('.icity-card');
            
            cards.forEach(card => {
                card.addEventListener('click', function(e) {
                    const url = card.getAttribute('data-url');
                    if (url) {
                        const clickedElement = e.target;
                        const isLink = clickedElement.closest('a');
                        const isImage = clickedElement.closest('.icity-card-images');
                        
                        if (!isLink && !isImage) {
                            window.location.href = url;
                        }
                    }
                });
            });
        });
    </script>
{{ end }}
