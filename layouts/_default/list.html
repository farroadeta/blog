{{ define "main" }}
    <div class="list-container">
        <h1 id="list-title" class="list-title">
        {{ if eq .RelPermalink "/posts/" }}
            归档
        {{ else if hasPrefix .RelPermalink "/posts/" }}
            {{ $pathParts := split (trim .RelPermalink "/") "/" }}
            {{ $lastPart := index (last 1 $pathParts) 0 }}
            {{ $lastPart }}
        {{ else }}
            {{ .Title }}
        {{ end }}
    </h1>
        {{ with .Description }}
        <p class="list-description">{{ . }}</p>
        {{ end }}
        
        {{ if eq .RelPermalink "/posts/" }}
        
        <div id="archive-breadcrumb" class="archive-breadcrumb">
            <div class="archive-breadcrumb-path-container">
                <a href="#" onclick="navigateTo(''); return false;" class="archive-breadcrumb-link">归档</a>
                <span id="breadcrumb-path"></span>
            </div>
        </div>
        
        <div id="archive-content"></div>
        
        <script>
        var allData = {{ $allData := slice }}
        {{ range .Site.RegularPages }}
        {{ if hasPrefix .RelPermalink "/posts/" }}
        {{ $path := "" }}
        {{ with .File }}
            {{ $path = replace .Dir "\\" "/" }}
            {{ $path = replace $path "posts/" "" }}
            {{ $path = trim $path "/" }}
        {{ end }}
        {{ $pathParts := split $path "/" }}
        {{ $folderName := index $pathParts 0 }}
        {{ if and $folderName (ne $folderName "posts") }}
        {{ $content := .Plain | truncate 200 }}
        {{ $images := slice }}
        {{ with .Params.cover }}
            {{ $images = $images | append . }}
        {{ end }}
        {{ $imgMatches := findRE "<img[^>]+src=\"([^\"]+)\"" .Content 3 }}
        {{ range $imgMatches }}
            {{ $src := replaceRE ".*src=\"([^\"]+)\".*" "$1" . }}
            {{ $images = $images | append $src }}
        {{ end }}
        {{ $author := .Params.author | default "七哇夸" }}
        {{ $avatar := printf "images/author/%s.png" $author }}
        {{ $authorKey := "qiwa" }}
        {{ if eq $author "商人" }}{{ $authorKey = "shangren" }}
        {{ else if eq $author "地理学家" }}{{ $authorKey = "dilixuejia" }}
        {{ else if eq $author "小王子" }}{{ $authorKey = "xiaowangzi" }}
        {{ else if eq $author "狐狸" }}{{ $authorKey = "huli" }}
        {{ else if eq $author "玫瑰" }}{{ $authorKey = "meigui" }}
        {{ else if eq $author "蛇" }}{{ $authorKey = "she" }}
        {{ else if eq $author "酒鬼" }}{{ $authorKey = "jiugui" }}
        {{ end }}
        {{ $signature := index $.Site.Params.authorSignatures $authorKey | default $.Site.Params.authorSignatures.qiwa }}
        {{ $allData = $allData | append (dict "path" $path "folder" $folderName "title" .Title "date" (.Date.Format "2006年01月02日") "url" .RelPermalink "content" $content "images" $images "author" $author "avatar" $avatar "signature" $signature) }}
        {{ end }}
        {{ end }}
        {{ end }}
        {{ $allData | jsonify | safeJS }};
        
        var currentPath = '';
        
        function getPathParts(path) {
            if (!path) return [];
            return path.split('/').filter(function(p) { return p.length > 0; });
        }
        
        function getFolders(path) {
            var folders = new Set();
            var targetParts = getPathParts(path);
            var targetDepth = targetParts.length;
            
            allData.forEach(function(item) {
                var itemParts = getPathParts(item.path);
                if (itemParts.length > targetDepth) {
                    var match = true;
                    for (var i = 0; i < targetDepth; i++) {
                        if (itemParts[i] !== targetParts[i]) {
                            match = false;
                            break;
                        }
                    }
                    if (match) {
                        folders.add(itemParts[targetDepth]);
                    }
                }
            });
            
            return Array.from(folders).sort();
        }
        
        function getFiles(path) {
            var targetParts = getPathParts(path);
            var targetDepth = targetParts.length;
            
            return allData.filter(function(item) {
                var itemParts = getPathParts(item.path);
                if (itemParts.length === targetDepth) {
                    var match = true;
                    for (var i = 0; i < targetDepth; i++) {
                        if (itemParts[i] !== targetParts[i]) {
                            match = false;
                            break;
                        }
                    }
                    return match;
                }
                return false;
            }).sort(function(a, b) {
                return new Date(b.date) - new Date(a.date);
            });
        }
        
        function goBack() {
            var currentParts = getPathParts(currentPath);
            if (currentParts.length > 0) {
                currentParts.pop();
                currentPath = currentParts.join('/');
                renderArchive();
            }
        }
        
        function navigateTo(path) {
            currentPath = path;
            renderArchive();
        }
        
        function renderArchive() {
            var content = document.getElementById('archive-content');
            var breadcrumb = document.getElementById('archive-breadcrumb');
            var breadcrumbPath = document.getElementById('breadcrumb-path');
            var listTitle = document.getElementById('list-title');
            
            var currentParts = getPathParts(currentPath);
            
            if (currentParts.length > 0) {
                listTitle.textContent = currentParts[currentParts.length - 1];
            } else {
                listTitle.textContent = '归档';
            }
            
            if (currentParts.length > 0) {
                breadcrumb.style.display = 'flex';
                var builtPath = '';
                var html = '';
                currentParts.forEach(function(part, i) {
                    builtPath += (builtPath ? '/' : '') + part;
                    var isLast = i === currentParts.length - 1;
                    if (isLast) {
                        html += '<span class="archive-breadcrumb-separator"> / </span><span class="archive-breadcrumb-current">' + part + '</span>';
                    } else {
                        html += '<span class="archive-breadcrumb-separator"> / </span><a href="#" onclick="navigateTo(\'' + builtPath + '\'); return false;" class="archive-breadcrumb-link">' + part + '</a>';
                    }
                });
                breadcrumbPath.innerHTML = html;
            } else {
                breadcrumb.style.display = 'none';
            }
            
            var folders = getFolders(currentPath);
            var files = getFiles(currentPath);
            
            var html = '';
            
            if (folders.length > 0) {
                html += '<div class="folder-card-grid">';
                folders.forEach(function(folder) {
                    var fullPath = currentPath ? currentPath + '/' + folder : folder;
                    html += '<a href="#" onclick="navigateTo(\'' + fullPath + '\'); return false;" class="folder-card">';
                    html += '<svg class="folder-card-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round">';
                    html += '<path d="M22 19a2 2 0 0 1-2 2H4a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h5l2 3h9a2 2 0 0 1 2 2z"></path>';
                    html += '</svg>';
                    html += '<h3 class="folder-card-name">' + folder + '</h3>';
                    html += '</a>';
                });
                html += '</div>';
            }
            
            if (files.length > 0) {
                html += '<div class="icity-card-list">';
                
                files.forEach(function(file) {
                    var title = file.title;
                    if (!title) {
                        var urlParts = file.url.split('/');
                        title = urlParts[urlParts.length - 2] || 'Untitled';
                        try {
                            title = decodeURIComponent(title);
                        } catch(e) {
                        }
                    }
                    
                    var content = file.content || '';
                    var imageCount = file.images ? file.images.length : 0;
                    
                    var avatarPath = file.avatar || 'images/avatar.png';
                    if (!avatarPath.startsWith('/')) {
                        avatarPath = '/' + avatarPath;
                    }
                    
                    html += '<article class="icity-card">';
                    html += '<div class="icity-card-header">';
                    html += '<div class="icity-card-avatar">';
                    html += '<img src="' + avatarPath + '" alt="avatar">';
                    html += '</div>';
                    html += '<div class="icity-card-user">';
                    html += '<a href="/character/' + encodeURIComponent(file.author) + '" class="icity-card-username-link">';
                    html += '<span class="icity-card-username">' + file.author + '</span>';
                    html += '</a>';
                    html += '<span class="icity-card-signature">' + file.signature + '</span>';
                    html += '</div>';
                    html += '</div>';
                    
                    html += '<div class="icity-card-body">';
                    html += '<h3 class="icity-card-title">';
                    html += '<a href="' + file.url + '">' + title + '</a>';
                    html += '</h3>';
                    html += '<p class="icity-card-content">' + content + '</p>';
                    
                    if (imageCount > 0) {
                        html += '<div class="icity-card-images" data-count="' + Math.min(imageCount, 3) + '">';
                        for (var i = 0; i < Math.min(imageCount, 3); i++) {
                            html += '<div class="icity-image-item">';
                            html += '<img src="' + file.images[i] + '" alt="图片" loading="lazy">';
                            html += '</div>';
                        }
                        html += '</div>';
                    }
                    
                    html += '</div>';
                    html += '<div class="icity-card-footer">';
                    html += '<span class="icity-card-date">' + file.date + '</span>';
                    html += '<span class="icity-card-path">' + file.path + '</span>';
                    html += '</div>';
                    html += '</article>';
                });
                
                html += '</div>';
            }
            
            content.innerHTML = html;
        }
        
        renderArchive();
        </script>
        
        {{ else }}
        
        <div class="icity-card-list">
            {{ range .Pages }}
            {{ $images := slice }}
            {{ with .Params.cover }}
                {{ $images = $images | append . }}
            {{ end }}
            {{ $imgMatches := findRE "<img[^>]+src=\"([^\"]+)\"" .Content 3 }}
            {{ range $imgMatches }}
                {{ $src := replaceRE ".*src=\"([^\"]+)\".*" "$1" . }}
                {{ $images = $images | append $src }}
            {{ end }}
            {{ $imageCount := len $images }}
            {{ $author := .Params.author | default "七哇夸" }}
            {{ $avatar := printf "images/author/%s.png" $author }}
            {{ $authorKey := "qiwa" }}
            {{ if eq $author "商人" }}{{ $authorKey = "shangren" }}
            {{ else if eq $author "地理学家" }}{{ $authorKey = "dilixuejia" }}
            {{ else if eq $author "小王子" }}{{ $authorKey = "xiaowangzi" }}
            {{ else if eq $author "狐狸" }}{{ $authorKey = "huli" }}
            {{ else if eq $author "玫瑰" }}{{ $authorKey = "meigui" }}
            {{ else if eq $author "蛇" }}{{ $authorKey = "she" }}
            {{ else if eq $author "酒鬼" }}{{ $authorKey = "jiugui" }}
            {{ end }}
            {{ $signature := index $.Site.Params.authorSignatures $authorKey | default $.Site.Params.authorSignatures.qiwa }}
            <article class="icity-card">
                <div class="icity-card-header">
                    <div class="icity-card-avatar">
                        <img src="{{ $avatar | relURL }}" alt="avatar">
                    </div>
                    <div class="icity-card-user">
                        <a href="{{ "/character/" | relURL }}{{ $author | urlize }}" class="icity-card-username-link">
                            <span class="icity-card-username">{{ $author }}</span>
                        </a>
                        <span class="icity-card-signature">{{ $signature }}</span>
                    </div>
                </div>
                <div class="icity-card-body">
                    <h3 class="icity-card-title">
                        <a href="{{ .RelPermalink }}">{{ with .File }}{{ .BaseFileName }}{{ else }}{{ .Title }}{{ end }}</a>
                    </h3>
                    <p class="icity-card-content">{{ .Plain | truncate 200 }}</p>
                    {{ if gt $imageCount 0 }}
                    <div class="icity-card-images" data-count="{{ $imageCount }}">
                        {{ range first 3 $images }}
                        <div class="icity-image-item">
                            <img src="{{ . }}" alt="图片" loading="lazy">
                        </div>
                        {{ end }}
                    </div>
                    {{ end }}
                </div>
                <div class="icity-card-footer">
                    <span class="icity-card-date">{{ .Date.Format "2006年01月02日" }}</span>
                    <span class="icity-card-path">
                        {{ with .File }}
                            {{ $path := replace .Dir "\\" "/" }}
                            {{ $path = replace $path "posts/" "" }}
                            {{ $path = trim $path "/" }}
                            {{ if $path }}
                                {{ $path }}
                            {{ end }}
                        {{ end }}
                    </span>
                </div>
            </article>
            {{ end }}
        </div>
        
        {{ end }}

    </div>
{{ end }}
