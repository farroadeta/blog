{{ define "main" }}
    <div class="list-container">
        <h1 class="list-title">{{ if eq .RelPermalink "/posts/" }}归档{{ else }}{{ .Title }}{{ end }}</h1>
        {{ with .Description }}
        <p class="list-description">{{ . }}</p>
        {{ end }}
        
        {{ if eq .RelPermalink "/posts/" }}
        
        <div id="archive-breadcrumb" style="display: none; margin-bottom: 1rem; padding: 0.75rem 1rem; background: var(--card-background); border: 1px solid var(--border-color); max-width: 800px; margin-left: auto; margin-right: auto;">
            <a href="#" onclick="navigateTo(''); return false;" style="text-decoration: none; color: var(--accent-color);">归档</a>
            <span id="breadcrumb-path"></span>
        </div>
        
        <div id="archive-content"></div>
        
        <script>
        var allData = {{ $allData := slice }}
        {{ range .Site.RegularPages }}
        {{ if hasPrefix .RelPermalink "/posts/" }}
        {{ $path := "" }}
        {{ with .File }}
            {{ $path = replace .Dir "\\" "/" }}
            {{ $path = replace $path "posts/" "" }}
            {{ $path = trim $path "/" }}
        {{ end }}
        {{ $pathParts := split $path "/" }}
        {{ $folderName := index $pathParts 0 }}
        {{ if and $folderName (ne $folderName "posts") }}
        {{ $content := .Plain | truncate 150 }}
        {{ $images := slice }}
        {{ with .Params.cover }}
            {{ $images = $images | append . }}
        {{ end }}
        {{ $imgMatches := findRE "<img[^>]+src=\"([^\"]+)\"" .Content 3 }}
        {{ range $imgMatches }}
            {{ $src := replaceRE ".*src=\"([^\"]+)\".*" "$1" . }}
            {{ if not (in $images $src) }}
                {{ $images = $images | append $src }}
            {{ end }}
        {{ end }}
        {{ $allData = $allData | append (dict "path" $path "folder" $folderName "title" .Title "date" (.Date.Format "2006-01-02") "url" .RelPermalink "content" $content "images" $images) }}
        {{ end }}
        {{ end }}
        {{ end }}
        {{ $allData | jsonify | safeJS }};
        
        var currentPath = '';
        
        function getPathParts(path) {
            if (!path) return [];
            return path.split('/').filter(function(p) { return p.length > 0; });
        }
        
        function getFolders(path) {
            var folders = new Set();
            var targetParts = getPathParts(path);
            var targetDepth = targetParts.length;
            
            allData.forEach(function(item) {
                var itemParts = getPathParts(item.path);
                if (itemParts.length > targetDepth) {
                    var match = true;
                    for (var i = 0; i < targetDepth; i++) {
                        if (itemParts[i] !== targetParts[i]) {
                            match = false;
                            break;
                        }
                    }
                    if (match) {
                        folders.add(itemParts[targetDepth]);
                    }
                }
            });
            
            return Array.from(folders).sort();
        }
        
        function getFiles(path) {
            var targetParts = getPathParts(path);
            var targetDepth = targetParts.length;
            
            return allData.filter(function(item) {
                var itemParts = getPathParts(item.path);
                if (itemParts.length === targetDepth) {
                    var match = true;
                    for (var i = 0; i < targetDepth; i++) {
                        if (itemParts[i] !== targetParts[i]) {
                            match = false;
                            break;
                        }
                    }
                    return match;
                }
                return false;
            }).sort(function(a, b) {
                return new Date(b.date) - new Date(a.date);
            });
        }
        
        function navigateTo(path) {
            currentPath = path;
            renderArchive();
        }
        
        function renderArchive() {
            var content = document.getElementById('archive-content');
            var breadcrumb = document.getElementById('archive-breadcrumb');
            var breadcrumbPath = document.getElementById('breadcrumb-path');
            
            var currentParts = getPathParts(currentPath);
            
            if (currentParts.length > 0) {
                breadcrumb.style.display = 'block';
                var builtPath = '';
                var html = '';
                currentParts.forEach(function(part, i) {
                    builtPath += (builtPath ? '/' : '') + part;
                    var isLast = i === currentParts.length - 1;
                    if (isLast) {
                        html += ' / <span style="color: var(--text-color);">' + part + '</span>';
                    } else {
                        html += ' / <a href="#" onclick="navigateTo(\'' + builtPath + '\'); return false;" style="text-decoration: none; color: var(--accent-color);">' + part + '</a>';
                    }
                });
                breadcrumbPath.innerHTML = html;
            } else {
                breadcrumb.style.display = 'none';
            }
            
            var folders = getFolders(currentPath);
            var files = getFiles(currentPath);
            
            var html = '';
            
            if (folders.length > 0) {
                html += '<div class="folder-card-grid" style="max-width: 800px; margin: 0 auto;">';
                folders.forEach(function(folder) {
                    var fullPath = currentPath ? currentPath + '/' + folder : folder;
                    html += '<a href="#" onclick="navigateTo(\'' + fullPath + '\'); return false;" class="folder-card">';
                    html += '<svg class="folder-card-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round">';
                    html += '<path d="M22 19a2 2 0 0 1-2 2H4a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h5l2 3h9a2 2 0 0 1 2 2z"></path>';
                    html += '</svg>';
                    html += '<h3 class="folder-card-name">' + folder + '</h3>';
                    html += '</a>';
                });
                html += '</div>';
            }
            
            if (files.length > 0) {
                html += '<div class="archive-card-list" style="max-width: 800px; margin: 1.5rem auto 0;">';
                
                files.forEach(function(file) {
                    var title = file.title;
                    if (!title) {
                        var urlParts = file.url.split('/');
                        title = urlParts[urlParts.length - 2] || 'Untitled';
                        try {
                            title = decodeURIComponent(title);
                        } catch(e) {
                            // 如果解码失败，保持原样
                        }
                    }
                    
                    var content = file.content || '';
                    var imageCount = file.images ? file.images.length : 0;
                    
                    html += '<article class="archive-card">';
                    html += '<div class="archive-card-header">';
                    html += '<div class="archive-card-avatar">';
                    html += '<img src="{{ "images/avatar.png" | relURL }}" alt="avatar">';
                    html += '</div>';
                    html += '<div class="archive-card-user">';
                    html += '<span class="archive-card-username">{{ .Site.Title }}</span>';
                    html += '<span class="archive-card-time">' + file.date + '</span>';
                    html += '</div>';
                    html += '</div>';
                    
                    html += '<div class="archive-card-body">';
                    html += '<h3 class="archive-card-title"><a href="' + file.url + '">' + title + '</a></h3>';
                    if (content) {
                        html += '<p class="archive-card-content">' + content + '</p>';
                    }
                    
                    // 图片展示
                    if (imageCount > 0) {
                        html += '<div class="archive-card-images" data-count="' + Math.min(imageCount, 3) + '">';
                        for (var i = 0; i < Math.min(imageCount, 3); i++) {
                            html += '<div class="archive-image-item">';
                            html += '<img src="' + file.images[i] + '" alt="图片" loading="lazy">';
                            html += '</div>';
                        }
                        html += '</div>';
                    }
                    
                    html += '</div>';
                    html += '</article>';
                });
                
                html += '</div>';
            }
            
            content.innerHTML = html;
        }
        
        renderArchive();
        </script>
        
        {{ else }}
        
        <div class="archive-card-list">
            {{ range .Pages }}
            {{ $images := slice }}
            {{ with .Params.cover }}
                {{ $images = $images | append . }}
            {{ end }}
            {{ $imgMatches := findRE "<img[^>]+src=\"([^\"]+)\"" .Content 3 }}
            {{ range $imgMatches }}
                {{ $src := replaceRE ".*src=\"([^\"]+)\".*" "$1" . }}
                {{ if not (in $images $src) }}
                    {{ $images = $images | append $src }}
                {{ end }}
            {{ end }}
            <article class="archive-card">
                <div class="archive-card-header">
                    <div class="archive-card-avatar">
                        <img src="{{ "images/avatar.png" | relURL }}" alt="avatar">
                    </div>
                    <div class="archive-card-user">
                        <span class="archive-card-username">{{ .Site.Title }}</span>
                        <span class="archive-card-time">{{ .Date.Format "2006-01-02" }}</span>
                    </div>
                </div>
                <div class="archive-card-body">
                    <h3 class="archive-card-title"><a href="{{ .RelPermalink }}">{{ .Title | default .File.BaseFileName }}</a></h3>
                    <p class="archive-card-content">{{ .Plain | truncate 150 }}</p>
                    {{ if gt (len $images) 0 }}
                    <div class="archive-card-images" data-count="{{ len $images }}">
                        {{ range first 3 $images }}
                        <div class="archive-image-item">
                            <img src="{{ . }}" alt="图片" loading="lazy">
                        </div>
                        {{ end }}
                    </div>
                    {{ end }}
                </div>
            </article>
            {{ end }}
        </div>
        
        {{ end }}

    </div>
{{ end }}
