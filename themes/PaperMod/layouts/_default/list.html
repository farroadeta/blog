{{ define "main" }}
    <div class="list-container">
        <h1 class="list-title">{{ if eq .RelPermalink "/posts/" }}归档{{ else }}{{ .Title }}{{ end }}</h1>
        {{ with .Description }}
        <p class="list-description">{{ . }}</p>
        {{ end }}
        
        {{ if eq .RelPermalink "/posts/" }}
        
        <div id="archive-breadcrumb" style="display: none; margin-bottom: 1rem; padding: 0.75rem 1rem; background: var(--card-background); border: 1px solid var(--border-color); max-width: 800px; margin-left: auto; margin-right: auto;">
            <a href="#" onclick="navigateTo(''); return false;" style="text-decoration: none; color: var(--accent-color);">归档</a>
            <span id="breadcrumb-path"></span>
        </div>
        
        <div id="archive-content"></div>
        
        <script>
        var allData = {{ $allData := slice }}
        {{ range .Site.RegularPages }}
        {{ if hasPrefix .RelPermalink "/posts/" }}
        {{ $path := "" }}
        {{ with .File }}
            {{ $path = replace .Dir "\\" "/" }}
            {{ $path = replace $path "posts/" "" }}
            {{ $path = trim $path "/" }}
        {{ end }}
        {{ $pathParts := split $path "/" }}
        {{ $folderName := index $pathParts 0 }}
        {{ if and $folderName (ne $folderName "posts") }}
        {{ $allData = $allData | append (dict "path" $path "folder" $folderName "title" .Title "date" (.Date.Format "2006-01-02") "url" .RelPermalink) }}
        {{ end }}
        {{ end }}
        {{ end }}
        {{ $allData | jsonify | safeJS }};
        
        var currentPath = '';
        
        function getPathParts(path) {
            if (!path) return [];
            return path.split('/').filter(function(p) { return p.length > 0; });
        }
        
        function getFolders(path) {
            var folders = new Set();
            var targetParts = getPathParts(path);
            var targetDepth = targetParts.length;
            
            allData.forEach(function(item) {
                var itemParts = getPathParts(item.path);
                if (itemParts.length > targetDepth) {
                    var match = true;
                    for (var i = 0; i < targetDepth; i++) {
                        if (itemParts[i] !== targetParts[i]) {
                            match = false;
                            break;
                        }
                    }
                    if (match) {
                        folders.add(itemParts[targetDepth]);
                    }
                }
            });
            
            return Array.from(folders).sort();
        }
        
        function getFiles(path) {
            var targetParts = getPathParts(path);
            var targetDepth = targetParts.length;
            
            return allData.filter(function(item) {
                var itemParts = getPathParts(item.path);
                if (itemParts.length === targetDepth) {
                    var match = true;
                    for (var i = 0; i < targetDepth; i++) {
                        if (itemParts[i] !== targetParts[i]) {
                            match = false;
                            break;
                        }
                    }
                    return match;
                }
                return false;
            }).sort(function(a, b) {
                return new Date(b.date) - new Date(a.date);
            });
        }
        
        function navigateTo(path) {
            currentPath = path;
            renderArchive();
        }
        
        function renderArchive() {
            var content = document.getElementById('archive-content');
            var breadcrumb = document.getElementById('archive-breadcrumb');
            var breadcrumbPath = document.getElementById('breadcrumb-path');
            
            var currentParts = getPathParts(currentPath);
            
            if (currentParts.length > 0) {
                breadcrumb.style.display = 'block';
                var builtPath = '';
                var html = '';
                currentParts.forEach(function(part, i) {
                    builtPath += (builtPath ? '/' : '') + part;
                    var isLast = i === currentParts.length - 1;
                    if (isLast) {
                        html += ' / <span style="color: var(--text-color);">' + part + '</span>';
                    } else {
                        html += ' / <a href="#" onclick="navigateTo(\'' + builtPath + '\'); return false;" style="text-decoration: none; color: var(--accent-color);">' + part + '</a>';
                    }
                });
                breadcrumbPath.innerHTML = html;
            } else {
                breadcrumb.style.display = 'none';
            }
            
            var folders = getFolders(currentPath);
            var files = getFiles(currentPath);
            
            var html = '';
            
            if (folders.length > 0) {
                html += '<div class="folder-card-grid" style="max-width: 800px; margin: 0 auto;">';
                folders.forEach(function(folder) {
                    var fullPath = currentPath ? currentPath + '/' + folder : folder;
                    html += '<a href="#" onclick="navigateTo(\'' + fullPath + '\'); return false;" class="folder-card">';
                    html += '<svg class="folder-card-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round">';
                    html += '<path d="M22 19a2 2 0 0 1-2 2H4a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h5l2 3h9a2 2 0 0 1 2 2z"></path>';
                    html += '</svg>';
                    html += '<h3 class="folder-card-name">' + folder + '</h3>';
                    html += '</a>';
                });
                html += '</div>';
            }
            
            if (files.length > 0) {
                // 按日期分组
                var groupedFiles = {};
                files.forEach(function(file) {
                    if (!groupedFiles[file.date]) {
                        groupedFiles[file.date] = [];
                    }
                    groupedFiles[file.date].push(file);
                });
                
                html += '<div class="file-linear-list" style="max-width: 800px; margin: 1.5rem auto 0;">';
                
                // 遍历分组后的文件
                Object.keys(groupedFiles).sort().reverse().forEach(function(date) {
                    var dateFiles = groupedFiles[date];
                    
                    dateFiles.forEach(function(file, index) {
                        var title = file.title;
                        if (!title) {
                            var urlParts = file.url.split('/');
                            title = urlParts[urlParts.length - 2] || 'Untitled';
                            try {
                                title = decodeURIComponent(title);
                            } catch(e) {
                                // 如果解码失败，保持原样
                            }
                        }
                        
                        html += '<div class="file-linear-item" style="display: flex; margin-bottom: 0.75rem; align-items: baseline;">';
                        
                        // 只在每组的第一个文件显示日期
                        if (index === 0) {
                            html += '<span class="file-linear-date" style="font-size: 0.9rem; color: var(--text-secondary); white-space: nowrap; width: 100px; flex-shrink: 0;">' + date + '</span>';
                        } else {
                            html += '<span class="file-linear-date" style="font-size: 0.9rem; color: var(--text-secondary); white-space: nowrap; width: 100px; flex-shrink: 0; visibility: hidden;">' + date + '</span>';
                        }
                        
                        html += '<a href="' + file.url + '" style="text-decoration: none; color: var(--text-color); flex: 1;">';
                        html += '<h3 class="file-linear-title" style="margin: 0; font-size: 1rem; font-weight: 400;">' + title + '</h3>';
                        html += '</a>';
                        html += '</div>';
                    });
                });
                
                html += '</div>';
            }
            
            content.innerHTML = html;
        }
        
        renderArchive();
        </script>
        
        {{ else }}
        
        <div class="post-linear-list">
            {{ range .Pages }}
            <article class="post-linear-item">
                <div class="post-linear-left">
                    <div class="post-linear-header">
                        <h3 class="post-linear-title"><a href="{{ .RelPermalink }}">{{ .Title | default .File.BaseFileName }}</a></h3>
                    </div>
                    <div class="post-linear-footer">
                        <span class="post-linear-date">{{ .Date.Format "2006-01-02" }}</span>
                    </div>
                </div>
            </article>
            {{ end }}
        </div>
        
        {{ end }}

    </div>
{{ end }}
