{{ define "main" }}
<div class="search-container">
    <h1 class="search-title">搜索</h1>
    
    <!-- 搜索框区域 -->
    <div class="search-box-wrapper">
        <div class="search-box">
            <svg class="search-icon" xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <circle cx="11" cy="11" r="8"></circle>
                <line x1="21" y1="21" x2="16.65" y2="16.65"></line>
            </svg>
            <input type="text" id="search-input" placeholder="输入关键词搜索文章..." autocomplete="off">
            <div class="search-actions">
                <button id="toggle-advanced" class="search-action-btn" title="高级检索">
                    <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <line x1="4" y1="21" x2="4" y2="14"></line>
                        <line x1="4" y1="10" x2="4" y2="3"></line>
                        <line x1="12" y1="21" x2="12" y2="12"></line>
                        <line x1="12" y1="8" x2="12" y2="3"></line>
                        <line x1="20" y1="21" x2="20" y2="16"></line>
                        <line x1="20" y1="12" x2="20" y2="3"></line>
                        <line x1="1" y1="14" x2="7" y2="14"></line>
                        <line x1="9" y1="8" x2="15" y2="8"></line>
                        <line x1="17" y1="16" x2="23" y2="16"></line>
                    </svg>
                </button>
                <button id="search-clear" class="search-action-btn search-clear-btn" style="display: none;">
                    <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <line x1="18" y1="6" x2="6" y2="18"></line>
                        <line x1="6" y1="6" x2="18" y2="18"></line>
                    </svg>
                </button>
            </div>
        </div>
        
        <!-- 高级搜索面板 -->
        <div id="advanced-search-panel" class="advanced-search-panel" style="display: none;">
            <div class="advanced-search-grid">
                <!-- 作者筛选 -->
                <div class="search-filter">
                    <label for="filter-author">
                        <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"></path>
                            <circle cx="12" cy="7" r="4"></circle>
                        </svg>
                        作者
                    </label>
                    <select id="filter-author">
                        <option value="">全部作者</option>
                        <option value="七哇夸">七哇夸</option>
                        <option value="商人">商人</option>
                        <option value="地理学家">地理学家</option>
                        <option value="小王子">小王子</option>
                        <option value="狐狸">狐狸</option>
                        <option value="玫瑰">玫瑰</option>
                        <option value="蛇">蛇</option>
                        <option value="酒鬼">酒鬼</option>
                    </select>
                </div>
                
                <!-- 分类筛选 -->
                <div class="search-filter">
                    <label for="filter-category">
                        <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M22 19a2 2 0 0 1-2 2H4a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h5l2 3h9a2 2 0 0 1 2 2z"></path>
                        </svg>
                        分类
                    </label>
                    <select id="filter-category">
                        <option value="">全部分类</option>
                        <option value="Blog">Blog</option>
                        <option value="WebNote">WebNote</option>
                        <option value="学科笔记">学科笔记</option>
                    </select>
                </div>
                
                <!-- 日期范围 -->
                <div class="search-filter">
                    <label for="filter-date-from">
                        <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <rect x="3" y="4" width="18" height="18" rx="2" ry="2"></rect>
                            <line x1="16" y1="2" x2="16" y2="6"></line>
                            <line x1="8" y1="2" x2="8" y2="6"></line>
                            <line x1="3" y1="10" x2="21" y2="10"></line>
                        </svg>
                        开始日期
                    </label>
                    <input type="date" id="filter-date-from">
                </div>
                
                <div class="search-filter">
                    <label for="filter-date-to">
                        <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <rect x="3" y="4" width="18" height="18" rx="2" ry="2"></rect>
                            <line x1="16" y1="2" x2="16" y2="6"></line>
                            <line x1="8" y1="2" x2="8" y2="6"></line>
                            <line x1="3" y1="10" x2="21" y2="10"></line>
                        </svg>
                        结束日期
                    </label>
                    <input type="date" id="filter-date-to">
                </div>
            </div>
            
            <!-- 搜索范围 -->
            <div class="search-scope">
                <span class="scope-label">搜索范围：</span>
                <label class="checkbox-label">
                    <input type="checkbox" id="scope-title" checked>
                    <span>标题</span>
                </label>
                <label class="checkbox-label">
                    <input type="checkbox" id="scope-content" checked>
                    <span>正文</span>
                </label>
                <button id="reset-filters" class="reset-btn">重置</button>
            </div>
        </div>
    </div>
    
    <div id="search-stats" class="search-stats"></div>
    <div id="search-results" class="icity-card-list" style="max-width: 900px; margin: 1.5rem auto 0;"></div>
</div>

<script src="https://cdn.jsdelivr.net/npm/fuse.js@6.6.2"></script>
<script>
(function() {
    const searchInput = document.getElementById('search-input');
    const searchClear = document.getElementById('search-clear');
    const searchResults = document.getElementById('search-results');
    const searchStats = document.getElementById('search-stats');
    const toggleAdvanced = document.getElementById('toggle-advanced');
    const advancedPanel = document.getElementById('advanced-search-panel');
    const resetFilters = document.getElementById('reset-filters');
    
    // 高级筛选元素
    const filterAuthor = document.getElementById('filter-author');
    const filterCategory = document.getElementById('filter-category');
    const filterDateFrom = document.getElementById('filter-date-from');
    const filterDateTo = document.getElementById('filter-date-to');
    const scopeTitle = document.getElementById('scope-title');
    const scopeContent = document.getElementById('scope-content');
    
    let fuse = null;
    let searchData = [];
    let isAdvancedOpen = false;

    // 加载搜索数据
    fetch('{{ "index.json" | relURL }}')
        .then(response => response.json())
        .then(data => {
            searchData = data.items || data;
            searchData.forEach(item => {
                if (item.permalink || item.url) {
                    const url = item.permalink || item.url;
                    const match = url.match(/\/posts\/([^\/]+)/);
                    item.category = match ? match[1] : '';
                }
            });
            initFuse();
        })
        .catch(error => {
            console.error('加载搜索数据失败:', error);
            searchResults.innerHTML = '<div class="search-error">加载搜索数据失败，请刷新页面重试</div>';
        });

    // 初始化 Fuse
    function initFuse() {
        const keys = [];
        if (scopeTitle.checked) keys.push({ name: 'title', weight: 0.5 });
        if (scopeContent.checked) keys.push({ name: 'content', weight: 0.4 });
        
        if (keys.length === 0) {
            keys.push({ name: 'title', weight: 0.5 });
        }
        
        fuse = new Fuse(searchData, {
            keys: keys,
            includeScore: true,
            includeMatches: true,
            threshold: 0.3,
            minMatchCharLength: 2,
            ignoreLocation: true,
            distance: 100
        });
    }

    // 切换高级搜索面板
    toggleAdvanced.addEventListener('click', function(e) {
        e.stopPropagation();
        isAdvancedOpen = !isAdvancedOpen;
        advancedPanel.style.display = isAdvancedOpen ? 'block' : 'none';
        toggleAdvanced.classList.toggle('active', isAdvancedOpen);
    });

    // 点击外部关闭面板
    document.addEventListener('click', function(e) {
        if (!advancedPanel.contains(e.target) && e.target !== toggleAdvanced) {
            isAdvancedOpen = false;
            advancedPanel.style.display = 'none';
            toggleAdvanced.classList.remove('active');
        }
    });

    // 重置筛选条件
    resetFilters.addEventListener('click', function() {
        filterAuthor.value = '';
        filterCategory.value = '';
        filterDateFrom.value = '';
        filterDateTo.value = '';
        scopeTitle.checked = true;
        scopeContent.checked = true;
        initFuse();
        performSearch(searchInput.value);
    });

    // 监听筛选条件变化
    [filterAuthor, filterCategory, filterDateFrom, filterDateTo, scopeTitle, scopeContent].forEach(el => {
        el.addEventListener('change', function() {
            if (el.type === 'checkbox' && el.id.startsWith('scope-')) {
                initFuse();
            }
            performSearch(searchInput.value);
        });
    });

    // 高级筛选函数
    function applyAdvancedFilters(results) {
        return results.filter(result => {
            const item = result.item;
            
            if (filterAuthor.value && item.author !== filterAuthor.value) {
                return false;
            }
            
            if (filterCategory.value && item.category !== filterCategory.value) {
                return false;
            }
            
            if (item.date) {
                const itemDate = new Date(item.date.replace(/年|月/g, '-').replace(/日/, ''));
                
                if (filterDateFrom.value) {
                    const fromDate = new Date(filterDateFrom.value);
                    if (itemDate < fromDate) return false;
                }
                
                if (filterDateTo.value) {
                    const toDate = new Date(filterDateTo.value);
                    toDate.setHours(23, 59, 59);
                    if (itemDate > toDate) return false;
                }
            }
            
            return true;
        });
    }

    // 搜索功能
    function performSearch(query) {
        if (!fuse) return;
        
        const trimmedQuery = query.trim();
        let results = [];
        
        if (trimmedQuery) {
            results = fuse.search(trimmedQuery);
        } else {
            results = searchData.map(item => ({ item, score: 0, matches: [] }));
        }
        
        results = applyAdvancedFilters(results);
        displayResults(results, trimmedQuery);
    }

    // 显示搜索结果
    function displayResults(results, query) {
        if (results.length === 0) {
            const filterDesc = getFilterDescription();
            searchStats.innerHTML = `<span>未找到${filterDesc ? '满足条件' : '包含 "<strong>' + escapeHtml(query) + '</strong>"'} 的文章</span>`;
            searchResults.innerHTML = '<div class="search-no-results">没有找到相关文章，试试调整筛选条件？</div>';
            return;
        }

        const filterDesc = getFilterDescription();
        const queryDesc = query ? `包含 "<strong>${escapeHtml(query)}</strong>"` : '';
        const combinedDesc = [queryDesc, filterDesc].filter(Boolean).join(' 且 ');
        
        searchStats.innerHTML = `<span>找到 <strong>${results.length}</strong> 篇${combinedDesc ? combinedDesc : ''} 的文章</span>`;

        const html = results.map(result => {
            const item = result.item;
            const highlightedTitle = query ? highlightText(item.title, result.matches, 'title') : escapeHtml(item.title);
            const highlightedSummary = query ? highlightText(item.summary || item.content?.substring(0, 200) || '', result.matches, 'content') : escapeHtml(item.summary || item.content?.substring(0, 200) || '');
            const images = item.images || [];
            const imageCount = images.length;
            
            let imagesHtml = '';
            if (imageCount > 0) {
                imagesHtml = '<div class="icity-card-images" data-count="' + imageCount + '">';
                images.slice(0, 3).forEach(img => {
                    imagesHtml += '<div class="icity-image-item"><img src="' + img + '" alt="图片" loading="lazy"></div>';
                });
                imagesHtml += '</div>';
            }
            
            return `
                <article class="icity-card" data-images='${JSON.stringify(images)}' data-url="${item.permalink || item.url}">
                    <div class="icity-card-header">
                        <a href="/character/${encodeURIComponent(item.author)}" class="icity-card-avatar-link" title="查看${item.author}的详情">
                            <div class="icity-card-avatar">
                                <img src="${item.avatar}" alt="${item.author}的头像">
                            </div>
                        </a>
                        <div class="icity-card-user">
                            <a href="/character/${encodeURIComponent(item.author)}" class="icity-card-username-link">
                                <span class="icity-card-username">${item.author}</span>
                            </a>
                            <span class="icity-card-signature">${item.signature}</span>
                        </div>
                    </div>
                    <div class="icity-card-body">
                        ${item.title && item.title !== 'no' ? `
                        <h3 class="icity-card-title">
                            <a href="${item.permalink || item.url}">${highlightedTitle}</a>
                        </h3>
                        ` : ''}
                        <p class="icity-card-content">${highlightedSummary}...</p>
                        ${imagesHtml}
                    </div>
                    <div class="icity-card-footer">
                        <span class="icity-card-date">${item.date}</span>
                    </div>
                </article>
            `;
        }).join('');

        searchResults.innerHTML = html;
    }

    // 获取筛选描述
    function getFilterDescription() {
        const filters = [];
        
        if (filterAuthor.value) {
            filters.push(`作者: ${filterAuthor.value}`);
        }
        if (filterCategory.value) {
            filters.push(`分类: ${filterCategory.value}`);
        }
        if (filterDateFrom.value || filterDateTo.value) {
            const from = filterDateFrom.value || '开始';
            const to = filterDateTo.value || '现在';
            filters.push(`日期: ${from} 至 ${to}`);
        }
        
        return filters.length > 0 ? filters.join(', ') : '';
    }

    // 高亮匹配文本
    function highlightText(text, matches, key) {
        if (!matches || !text) return escapeHtml(text);
        
        const match = matches.find(m => m.key === key);
        if (!match) return escapeHtml(text);

        let result = '';
        let lastIndex = 0;
        
        match.indices.forEach(([start, end]) => {
            result += escapeHtml(text.substring(lastIndex, start));
            result += `<mark>${escapeHtml(text.substring(start, end + 1))}</mark>`;
            lastIndex = end + 1;
        });
        result += escapeHtml(text.substring(lastIndex));
        
        return result;
    }

    // HTML 转义
    function escapeHtml(text) {
        if (!text) return '';
        const div = document.createElement('div');
        div.textContent = text;
        return div.innerHTML;
    }

    // 输入事件
    let debounceTimer;
    searchInput.addEventListener('input', function() {
        clearTimeout(debounceTimer);
        const query = this.value;
        
        searchClear.style.display = query ? 'flex' : 'none';
        
        debounceTimer = setTimeout(() => {
            performSearch(query);
        }, 300);
    });

    // 清除按钮
    searchClear.addEventListener('click', function() {
        searchInput.value = '';
        searchClear.style.display = 'none';
        performSearch('');
        searchInput.focus();
    });

    // 键盘快捷键
    document.addEventListener('keydown', function(e) {
        if ((e.ctrlKey || e.metaKey) && e.key === 'k') {
            e.preventDefault();
            searchInput.focus();
        }
        if (e.key === 'Escape') {
            if (document.activeElement === searchInput) {
                searchInput.value = '';
                searchClear.style.display = 'none';
                performSearch('');
            }
            isAdvancedOpen = false;
            advancedPanel.style.display = 'none';
            toggleAdvanced.classList.remove('active');
        }
    });

    // 卡片点击跳转功能
    document.addEventListener('click', function(e) {
        const card = e.target.closest('.icity-card');
        if (card) {
            const url = card.getAttribute('data-url');
            if (url) {
                const clickedElement = e.target;
                const isLink = clickedElement.closest('a');
                const isImage = clickedElement.closest('.icity-card-images');
                
                if (!isLink && !isImage) {
                    window.location.href = url;
                }
            }
        }
    });

    // 页面加载时检查 URL 参数
    const urlParams = new URLSearchParams(window.location.search);
    const searchQuery = urlParams.get('q');
    if (searchQuery) {
        searchInput.value = searchQuery;
        searchClear.style.display = 'flex';
        setTimeout(() => performSearch(searchQuery), 500);
    }
})();
</script>
{{ end }}
