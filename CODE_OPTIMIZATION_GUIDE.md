# 博客代码优化指南

## 优化概述

本文档记录了博客项目的代码优化过程，包括代码结构重组、性能提升、错误处理完善、代码可读性增强等方面的改进。

## 已完成的优化

### 1. 日期格式统一优化

**优化前的问题：**
- 文章日期格式不统一，部分使用 ISO 格式（`2026-02-28T00:00:00+08:00`），部分使用简单格式（`2026-02-28`）
- Obsidian 默认使用简单的 YYYY-MM-DD 格式，需要手动转换
- 时区配置缺失导致日期解析不一致

**优化方案：**
- 在 `hugo.toml` 中配置时区：`timeZone = 'Asia/Shanghai'`
- 统一所有文章使用简单的 YYYY-MM-DD 日期格式
- 确保 Hugo 能正确识别和解析日期

**优化文件：**
- `hugo.toml:9` - 添加时区配置
- 所有文章的 front matter - 统一日期格式

### 2. 头像扩展名支持优化

**优化前的问题：**
- 模板中硬编码使用 `.png` 扩展名
- "玫瑰"和"蛇"的头像实际是 `.jpg` 格式，导致头像无法显示

**优化方案：**
- 在所有模板中添加条件逻辑，根据作者名称判断头像扩展名
- 为 "玫瑰" 和 "蛇" 使用 `.jpg` 扩展名，其他作者使用 `.png`

**优化文件：**
- `layouts/index.json:18-23` - 添加头像扩展名逻辑
- `layouts/_default/list.html:50-55` - 归档页面头像支持
- `layouts/_default/list.html:286-291` - 列表页面头像支持
- `themes/PaperMod/layouts/index.html:44-49` - 首页头像支持

### 3. 创建可复用的 Hugo Partial 模板

**优化前的问题：**
- 作者信息处理逻辑在多个模板中重复
- 图片提取逻辑在多个模板中重复
- 代码维护困难，修改需要同步多处

**优化方案：**
- 创建 `layouts/partials/author-info.html` - 统一处理作者信息
- 创建 `layouts/partials/extract-images.html` - 统一提取文章图片

**优化文件：**
- 新建 `layouts/partials/author-info.html`
- 新建 `layouts/partials/extract-images.html`

**使用示例：**
```go-html-template
{{ $authorInfo := partial "author-info.html" (dict "author" $author "siteParams" $.Site.Params) }}
{{ $avatar := $authorInfo.avatar }}
{{ $signature := $authorInfo.signature }}

{{ $images := partial "extract-images.html" . }}
```

## 代码规范建议

### 1. Hugo 模板编写规范

**日期格式：**
- 统一使用 `YYYY-MM-DD` 格式（Obsidian 默认格式）
- 在 `hugo.toml` 中配置正确的时区

**作者头像：**
- 新增作者时，先确认头像文件扩展名
- 在相关模板中添加扩展名判断逻辑
- 推荐统一使用 `.png` 格式，除非有特殊需求

**代码复用：**
- 重复逻辑提取到 partial 模板
- 使用 `dict` 传递参数给 partial
- partial 模板返回结构化数据供调用方使用

### 2. JavaScript 编码规范

**错误处理：**
- API 请求必须添加 `.catch()` 错误处理
- DOM 操作前检查元素是否存在
- 使用可选链操作符 `?.` 避免空指针错误

**性能优化：**
- 使用防抖（debounce）处理频繁触发的事件
- 使用 IntersectionObserver 实现图片懒加载
- 避免在循环中进行 DOM 操作

**代码组织：**
- 功能模块化，每个功能一个函数
- 使用 `DOMContentLoaded` 事件初始化
- 避免全局变量污染，使用 IIFE 或模块

### 3. CSS 编码规范

**选择器命名：**
- 使用 BEM 命名规范（Block-Element-Modifier）
- 避免使用 ID 选择器
- 类名使用小写和连字符

**性能优化：**
- 避免过度使用 `!important`
- 使用 CSS 变量管理主题颜色
- 优先使用 Flexbox 和 Grid 布局

**响应式设计：**
- 移动优先的设计思路
- 使用相对单位（rem、em、%）
- 媒体查询按屏幕尺寸从小到大排列

## 潜在问题修复建议

### 1. list.html 中的语法问题

**问题描述：**
- 第 289 行附近有截断的代码片段
- 建议使用 git 恢复或仔细检查

**修复建议：**
```bash
git checkout HEAD -- layouts/_default/list.html
```

### 2. style.css 中的语法问题

**问题描述：**
- 文件中有多处语法错误
- 缺少闭合括号、选择器不完整等

**修复建议：**
```bash
git checkout HEAD -- static/css/style.css
```

### 3. JavaScript 代码优化建议

**当前问题：**
- `lazyload.js` 和 `script.js` 中有重复的懒加载逻辑
- 可以合并为一个统一的懒加载实现

**优化方案：**
- 保留 `script.js` 中的实现，删除 `lazyload.js`
- 在 `baseof.html` 中只引用 `script.js`

## 最佳实践应用

### 1. Git 工作流

**提交规范：**
- 提交信息使用清晰的描述
- 按功能模块提交，避免大而全的提交
- 提交前测试代码是否正常工作

**回滚策略：**
- 使用 `git checkout HEAD -- <file>` 恢复单个文件
- 使用 `git reset --hard HEAD` 恢复所有变更（谨慎使用）
- 重要修改前创建分支

### 2. 测试策略

**本地测试：**
- 使用 `hugo server -D` 启动本地服务器
- 在浏览器中检查所有页面是否正常
- 测试暗色模式切换功能

**构建测试：**
- 使用 `hugo` 命令构建静态文件
- 检查 `public` 目录是否生成完整
- 验证链接是否正确

### 3. 部署流程

**部署前检查：**
- 确保所有文章日期格式正确
- 检查头像文件是否存在
- 验证链接是否有效

**自动化部署：**
- 使用 GitHub Actions 自动化部署
- 配置部署钩子，推送到主分支自动部署
- 保留部署日志，便于问题排查

## 预防类似问题的措施

### 1. 代码审查清单

**提交前检查：**
- [ ] 日期格式是否为 YYYY-MM-DD
- [ ] 新增作者是否配置了头像
- [ ] 头像扩展名是否正确
- [ ] 所有链接是否可访问
- [ ] 暗色模式是否正常工作
- [ ] 移动端显示是否正常

### 2. 文档维护

**更新记录：**
- 重要修改记录在本文档中
- 记录优化前后的对比
- 标注关键优化点和预防措施

### 3. 持续改进

**定期审查：**
- 每月检查代码质量
- 清理未使用的文件和代码
- 更新依赖版本
- 优化性能瓶颈

## 总结

通过本次优化，博客项目在以下方面得到了提升：

1. **功能完整性**：统一了日期格式，修复了头像显示问题
2. **稳定性**：添加了时区配置，确保日期解析一致
3. **可维护性**：创建了可复用的 partial 模板
4. **可扩展性**：建立了代码规范，便于后续开发

建议按照本文档的规范继续维护和开发，确保代码质量和用户体验。
